import 'package:injectable/injectable.dart';\nimport 'package:local_auth/local_auth.dart';\nimport 'package:logger/logger.dart';\n\nimport '../storage/secure_storage_service.dart';\nimport '../constants/storage_keys.dart';\nimport '../errors/app_error.dart';\n\n@lazySingleton\nclass BiometricService {\n  final LocalAuthentication _localAuth;\n  final SecureStorageService _secureStorage;\n  final Logger _logger;\n\n  BiometricService(\n    this._localAuth,\n    this._secureStorage,\n    this._logger,\n  );\n\n  /// Check if biometric authentication is available on the device\n  Future<bool> isBiometricAvailable() async {\n    try {\n      final isAvailable = await _localAuth.canCheckBiometrics;\n      final isDeviceSupported = await _localAuth.isDeviceSupported();\n      return isAvailable && isDeviceSupported;\n    } catch (e) {\n      _logger.e('Error checking biometric availability: $e');\n      return false;\n    }\n  }\n\n  /// Get list of available biometric types\n  Future<List<BiometricType>> getAvailableBiometrics() async {\n    try {\n      return await _localAuth.getAvailableBiometrics();\n    } catch (e) {\n      _logger.e('Error getting available biometrics: $e');\n      return [];\n    }\n  }\n\n  /// Check if biometric authentication is enabled by user\n  Future<bool> isBiometricEnabled() async {\n    try {\n      final enabled = await _secureStorage.read(StorageKeys.biometricEnabled);\n      return enabled == 'true';\n    } catch (e) {\n      _logger.e('Error checking biometric enabled status: $e');\n      return false;\n    }\n  }\n\n  /// Enable biometric authentication\n  Future<void> enableBiometric() async {\n    try {\n      // First verify that biometric is available\n      final isAvailable = await isBiometricAvailable();\n      if (!isAvailable) {\n        throw const AppError.biometricNotAvailable();\n      }\n\n      // Test biometric authentication\n      final authenticated = await authenticateWithBiometric(\n        reason: 'Enable biometric authentication for secure login',\n      );\n\n      if (authenticated) {\n        await _secureStorage.write(StorageKeys.biometricEnabled, 'true');\n        _logger.i('Biometric authentication enabled successfully');\n      } else {\n        throw const AppError.biometricAuthenticationFailed();\n      }\n    } catch (e) {\n      _logger.e('Error enabling biometric: $e');\n      rethrow;\n    }\n  }\n\n  /// Disable biometric authentication\n  Future<void> disableBiometric() async {\n    try {\n      await _secureStorage.delete(StorageKeys.biometricEnabled);\n      _logger.i('Biometric authentication disabled');\n    } catch (e) {\n      _logger.e('Error disabling biometric: $e');\n      rethrow;\n    }\n  }\n\n  /// Authenticate using biometric\n  Future<bool> authenticateWithBiometric({\n    required String reason,\n    bool stickyAuth = true,\n    bool biometricOnly = false,\n  }) async {\n    try {\n      // Check if biometric is available and enabled\n      final isAvailable = await isBiometricAvailable();\n      final isEnabled = await isBiometricEnabled();\n\n      if (!isAvailable) {\n        throw const AppError.biometricNotAvailable();\n      }\n\n      if (!isEnabled) {\n        throw const AppError.biometricNotEnabled();\n      }\n\n      // Perform biometric authentication\n      final authenticated = await _localAuth.authenticate(\n        localizedReason: reason,\n        options: AuthenticationOptions(\n          stickyAuth: stickyAuth,\n          biometricOnly: biometricOnly,\n        ),\n      );\n\n      if (authenticated) {\n        _logger.i('Biometric authentication successful');\n        return true;\n      } else {\n        _logger.w('Biometric authentication failed or cancelled');\n        return false;\n      }\n    } catch (e) {\n      _logger.e('Error during biometric authentication: $e');\n      \n      // Handle specific error types\n      if (e.toString().contains('NotAvailable')) {\n        throw const AppError.biometricNotAvailable();\n      } else if (e.toString().contains('NotEnrolled')) {\n        throw const AppError.biometricNotEnrolled();\n      } else if (e.toString().contains('LockedOut')) {\n        throw const AppError.biometricLockedOut();\n      } else {\n        throw AppError.biometricAuthenticationFailed(message: e.toString());\n      }\n    }\n  }\n\n  /// Get biometric type string for display\n  String getBiometricDisplayName(BiometricType type) {\n    switch (type) {\n      case BiometricType.face:\n        return 'Face Recognition';\n      case BiometricType.fingerprint:\n        return 'Fingerprint';\n      case BiometricType.iris:\n        return 'Iris Recognition';\n      case BiometricType.weak:\n        return 'Weak Biometric';\n      case BiometricType.strong:\n        return 'Strong Biometric';\n    }\n  }\n\n  /// Get appropriate icon for biometric type\n  String getBiometricIcon(BiometricType type) {\n    switch (type) {\n      case BiometricType.face:\n        return 'face_recognition';\n      case BiometricType.fingerprint:\n        return 'fingerprint';\n      case BiometricType.iris:\n        return 'iris_recognition';\n      case BiometricType.weak:\n      case BiometricType.strong:\n        return 'security';\n    }\n  }\n\n  /// Check if user should be prompted to enable biometric\n  Future<bool> shouldPromptBiometricSetup() async {\n    try {\n      final isAvailable = await isBiometricAvailable();\n      final isEnabled = await isBiometricEnabled();\n      final hasBeenPrompted = await _secureStorage.read(StorageKeys.biometricPrompted) == 'true';\n      \n      return isAvailable && !isEnabled && !hasBeenPrompted;\n    } catch (e) {\n      _logger.e('Error checking biometric setup prompt: $e');\n      return false;\n    }\n  }\n\n  /// Mark that user has been prompted about biometric setup\n  Future<void> markBiometricPrompted() async {\n    try {\n      await _secureStorage.write(StorageKeys.biometricPrompted, 'true');\n    } catch (e) {\n      _logger.e('Error marking biometric prompted: $e');\n    }\n  }\n\n  /// Clear all biometric data (e.g., on logout)\n  Future<void> clearBiometricData() async {\n    try {\n      await _secureStorage.delete(StorageKeys.biometricEnabled);\n      await _secureStorage.delete(StorageKeys.biometricPrompted);\n      _logger.i('Biometric data cleared');\n    } catch (e) {\n      _logger.e('Error clearing biometric data: $e');\n    }\n  }\n}